---
title: 'Cloudflare Tail Worker'
date: '2025-10-01T11:48:58.740Z'
draft: false
tags: ['cloudflare', 'worker']
slug: 'cloudflare-tail-worker'
navigation: false
competence: 'pro'
image: '/images/articles/20251001.cloudflare-tail-worker.png'
---

С **Cloudflare Tail Worker** насочвате логването на едно място - всичко е в екосистемата и в реално време.
До скоро ползвах само външни инструменти като **Sentry**, **LogRocket** или **Loki** с **Grafana**, 
но подкарването им изисква да познаваш процесинга и отнема време.

<!--more-->

Много често, когато ползвате *[__SaaS__] (Software as a Service)* услуги нямате достъп до логовете - 
или ако имате, логовете са силно орязани. Тогава си конфигурирате средата за разработка максимално близка 
до продукционната и се опитвате да симулирате грешките или създавате процес, на който пращате грешките и 
от там ги засилвате към външен инструмент.

Всеки Worker в Cloudflare има собствени логове, но нямате особен контрол върху тях. А, когато се налага да 
следите повече от един Worker, спрямо време, в което са се случило някакво събитие във всички тези Workers, 
нещата загрубяват. Затова си създавате, отделно, един нормален Worker, но `async fetch(request, env, ctx)` 
функцията я кръщавате `async tail(events, env, ctx)` и вече имате дефиниран _Tail Worker_.

```typescript
// src/index.ts

export default {
  async tail(events: TraceItem[], _env: unknown, _ctx: unknown) {
    if (!events || events.length === 0) {
      return;
    }

    console.log(`[TAIL] Получени ${events.length} събития`);

    for (const trace of events) {
      try {
        handleTraceItem(trace); // Вашата функция за обработка на събитията
      } catch (error) {
        console.error(`[TAIL_ERROR] Грешка при обработка на събитие: ${error instanceof Error ? error.message : String(error)}`);
      }
    }

    console.log(`[TAIL] Завършена обработка на ${events.length} събития`);
  }
} satisfies ExportedHandler;
```

Кръщавате Вашия Worker - например: `tail-for-me-all-the-app-events`. Добавяте във `wrangler.jsonc` ред

```json
{
  // ...
  "observability": { 
    "enabled": true 
  }
}
```

и го качвате на Cloudflare. Готово - имате активен Tail Worker.

От тук нататък, във всеки един ***Producer Worker***, на който искате да следите логовете, добавяте в неговия `wrangler.jsonc`:

```json
{
  // ...
  "tail_consumers": [
    {
      "service": "tail-for-me-all-the-app-events"
    }
  ]
}
```

За момента няма ограничение на броя Producer Workers, които могат да пращат логовете си към даден Tail Worker.
Трябва да знаете, че над определено време на ползване на CPU, Cloudflare ще Ви таксува допълнително.

Основно следвам 2 правила
- Ако два или повече Producer Workers споделят поне една база - ползват общ Tail Worker. 
- Един Producer Worker ползва повече от един Tail Worker, само ако има дефинирани правила за достъп.

---

::note
Създадох един **GitHub Gist** с [пример на `handleTraceItem` функцията](https://gist.github.com/howbizarre/2643b54a2af7c9494f8befe1fd1dd8ba).
::

---

::comments
---
discussions: https://github.com/howbizarre/hbsthoughts/discussions
---
::
